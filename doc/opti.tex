%  File      : /afs/psi.ch/user/f/flechsig/phase/doc/opti.tex
%  Date      : <28 Oct 03 11:11:19 flechsig> 
%  Time-stamp: <28 Oct 03 11:16:02 flechsig> 
%  Author    : Uwe Flechsig, flechsig@psi.ch

%  $Source$ 
%  $Date$
%  $Revision$ 
%  $Author$ 


\chapter{Optimization Program PHASEOPTI}   
The \phaseopti ~program is an useful tool at the final step of the
design process of an optical system. Applying the \minuit package from
the \cern-- library \cite {MINUIT} it can be used to optimize up to
100 parameters of an optical system simultaneously. In practical
applications the number of free parameters would be much lower. The
program describes the parameters $P_i$ via the following index:
\[ Index= (ElementNumber * 256) + (OptElementIndex * 128) + GeometryIndex \] 
\[ elementnumber = 0, 1, 2, \ldots .\]

The program seeks the minimum of a wighted sum of optical abberations
in a function \mbox {} $f(P_1, P_2,\ldots, P_N, F_{ij})$ (sum of
selected matrix elements in the resulting transformation matrix for
the system). The name of that function is fixed the prototype is \prog
{costfor(double *)}, this function is implemented in the file \prog
{cost.for}. It is possible to minimize the abberation function
dependent on two parameters $x, y$ which are steped in a user--
modifyalble way. That means minimization of a function $f(P_1,
P_2,\ldots, P_N, F_{ij}, x, y)$.

Two files control the program, the main command file for building the
optical system and the other one for the \minuit -- commands.  The
files are generated by the \phase-- user API (aplication interface) or
may be edited seperately.

\section{Control-- File Generation with the PHASE-- API}
\begin{enumerate}
\item The individual optical Elements have to be described with the
\phase API similar to ray-- trace calculations, that means the files
\prog {elementname.date} and \prog {elementname.datg} have to be
generated.  {\bf In the optimization program the *.date, *.datg files
must have the same name for one Element!} (In the \phase program that
is not necessary).
\item Generation of the control files with the \menu {Edit/Optimization Box}.
The name of the main control file \mlabel{OptiPickFileName} is selected by the 
\menu {File/Files}-- Box, \menu{ Opti Pickfile}-- Button. 
\end {enumerate}         

\section{Optimization Box}

The Optimization box is vertically divided into 4 areas, separated by
horizontal lines (figure \ref {obox}).
\begin {enumerate} 
\item File-- button area.
	\begin {enumerate} 
	\item Result-- File button: This file contains the results of the
optimization. The files with the extension \prog {*.omx;version} contains
the optimized matrixes. One have to be careful with the version number. For
each optimization $x_i, y_j$ the resulting product matrix is saved.
\item \mlabel{\minuit-- File button}: This file contains the commands for 
\minuit.
\end {enumerate}      
\item  upper(1.) scrolled list: Contains the *.date files as a representative 
for the individual optical elements in the correct order. The first element 
must be the first file in the list. Files can be added/ deleted by the $'+,-'$ 
buttons  on  the right.
\item middle (2.) scrolled list: Contains the list of parameters. If one item
is selected in the 1. and in the 2. list the index is calculated and shown in 
the index field. 
\item lower (3.) scrolled list: Contains the parameter list for the
optimization. The inputs are generated by the edit field and the $'+,-'$
buttons. A template for the input is shown obove the edit field.
\begin {enumerate}   
\item 1. line: \prog {x: xindex numberofxpoints deltax}    
\item 2. line: \prog {y: xindey numberofxpoints deltay}    
\item 3. and following lines:\hfill \\
         \prog {index 'nameoftheparameter' start accuracy min max}; (up to 100 
parameters are possible). The input of min and max are optional. {\sc
Minuit} recomends to use min/max only if necessary and the optimization finds
unphysical regions.   
\end {enumerate}      
Lines 1, 2 must be present if not needed input dummys with indice not used
during optimization, because the number of optimizations is the product of 
numberofxpoints and numberofypoints. The stepped $x,y$ values are
calculated by the following formula:
\[ x= xoriginal + i * deltax,\]
with $i= 0,1,\ldots numberofxpoints-1$ and  $xoriginal$ as the value of x in
the \prog {*.date} or \prog{*.datg} files.
\end {enumerate}  
\begin{figure}
\centerline{ \hbox{
 \epsfig{figure=obox.eps,height=7cm}}}  
  \caption {\label{obox} \phase API-- Optimization/Extraction Box} 
\end {figure}   
 
The \menu {OK} button creates the two  control files mentioned above.

\section {User Cost Function}    
If the default cost function minimizing $F_{20}^2 + F_{30}^2$
is not sufficient, recompiling and linking of the program is necessary.
Do as follows:
\begin {enumerate}    
\item Create a directory for the optimization program on your account.
\item Copy \prog {cost.for, makefile} into that directory.
\item Edit your \prog {phaseinit.com} file and change the  \prog {OPTI\$PRG} 
define,
and the \prog {PHASEOPTI} symbol appropriate to the new directory.
\item Initialize the new environment starting \prog {@phaseinit.com}. 
\item Change into the new directory.
\item Edit \prog {cost.for} for your needs. 
\item Build the optimization program \prog {make}.
\end {enumerate}    

The following listing is an example of user cost function. 
The vertical deviation from the optical axis
dependig on the divergencies dy an dz are minimized.
\begin{small}
\begin{verbatim}
C*****************************************************************
        subroutine costfor(dres)  !do not modify the funtion name!
C*****************************************************************
C       BERECHNUNG VON CHI_SQUARE
C
C*****************************************************************
      IMPLICIT REAL*8(A-H,O-Z)
      real*8 dres                               ! result back to C     

      
        common/map7/wc(0:4,0:4,0:4,0:4),
     &              xlc(0:4,0:4,0:4,0:4),
     &              ypc1(0:4,0:4,0:4,0:4),
     &              zpc1(0:4,0:4,0:4,0:4)
        common/map8/dyp1c(0:4,0:4,0:4,0:4),
     &              dzp1c(0:4,0:4,0:4,0:4),
     &              dypc(0:4,0:4,0:4,0:4),
     &              dzpc(0:4,0:4,0:4,0:4)
        common/map35/xmap35(35,35)

c************* input *******************************************
	iord=3       ! 3 order calculation
        dy= 0.001    ! 1 mrad
        dz= 0.001    ! 1 mrad
c************ extract transformation ***************************
        nn=0
        do i=0,iord
           do j=0,iord-i
              do k=0,iord-i-j
                 do l=0,iord-i-j-k
	            nn=nn+1
                    ypc1(i,j,k,l)=xmap35(21,nn)
         	    zpc1(i,j,k,l)=xmap35(11,nn)
         	    dypc(i,j,k,l)=xmap35(5,nn)
         	    dzpc(i,j,k,l)=xmap35(2,nn)
                 enddo
               enddo        
       	    enddo
       	 enddo        

c************* calculate chi-square ************************

           dres=ypc1(0,0,1,0)*dy+     	    ! DEFOCUS.  dy
     &	        ypc1(0,0,2,0)*dy*dy+        ! COMA      dy^2
     &	        ypc1(0,0,3,0)*dy*dy*dy +    ! SPH. ABB. dy^3
     &		ypc1(0,0,1,1)*dy*dz                   
        RETURN
        END

\end{verbatim}   
\end{small}

\section{Using the Optimization}
If the command files are generated there are different possibilities
to start the optimization.
\begin {enumerate} 
\item  \phase API: \menu {Commands/Calculation/Beamline Optimization}
\item Outside the API: \prog {phaseopti OptiPickFileName.pcko}  
\item Create a batchfile and submit it into a batch queue. This is generally 
recommended for a higher number of free parameters and steps.  
\end {enumerate}       

%\chapter {PHASEEXTRACT}   

%\unitlength1.0cm
%\begin{figure}[ht]
%	\begin{picture}(16,3.5)
%\put(4,1){\framebox(8,2){}}  
%                                 \put(8,2.3){I}                 \put(11.5,2.6){B}     
%\put(4.2,1.8){D}  \put(6,1.8){E} \put(8,1.8){F} \put(10,1.8){G} \put(11.5,1.8){C}   
%                                 \put(8,1.3){H}                 \put(11.5,1.1){A}     
%\put(10,0){Kreuz} \put(11.3,0.3){\vector(1,1){0.5}}
%  
%	\end    {picture} 
%	\caption{\label{s1} Spiegel mit markierten Me\3punkten}  
%\end{figure} 
%\vspace{0.5cm}

%\begin{figure}[htb]
%\centerline{
%\psfig{figure=[.clrauht]bi1341.ps,height=9cm} \vspace{.5cm}
%}   
%\caption {Zylinderspiegel, Objektiv 40 x} 
%\end {figure}     



\tiny{\it filename: opti.tex}     
%\clearpage


