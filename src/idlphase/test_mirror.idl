;-*-idlwave-*-
; File      : /afs/psi.ch/user/f/flechsig/phase/src/idlphase/test_mirror.idl
; Date      : <18 Jun 14 11:36:21 flechsig> 
; Time-stamp: <20 Jun 14 15:54:22 flechsig> 
; Author    : Uwe Flechsig, uwe.flechsig&#64;psi.&#99;&#104;

; $Source$ 
; $Date$
; $Revision$ 
; $Author$ 

;; test the mirror routine
;; a) gaussian source in 125 m, b) tor mirror as phase shifter
;; c) a propagator to see the tilt

drift2=33                         ;; drift after phaseplate 33 m
cols=3                            ;; 3 columns
rows=4                            ;; 4 rows
thetag= 3e-3                      ;; the grazing angle
sizez= 1e-3                       ;; the hor and vertical FOV
wavelength= 1.24e-10              ;; wavelength 1A
rw=1.74e4                         ;; 1.74e4
rl=0.1566                         ;; 0.1566
;; 125:33=> fwl=26.10

emf=initphase()

;; source
emf->gaussbeam, dist=125, Nz=243, sizez=sizez, w0=27.7e-6 , wavelength=wavelength
mywindow,1,1,cols=cols,rows=rows 
emf->plotintensity
f= emf->getphase(/raw)
z= emf->getz_vec()
y= emf->gety_vec()
fu= unwrap_phase(f)
mywindow,1,2,cols=cols,rows=rows
mycontour,fu,z,y
mywindow,1,3,cols=cols,rows=rows
emf->plotphase
emf->h5_write,'test_mirror.h5'


;; mirror
emf->mirror, thetag=thetag, rw=rw, rl=rl
;emf->statistics
mywindow,2,1,cols=cols,rows=rows 
emf->plotintensity
f= emf->getphase(/raw)
z= emf->getz_vec()
y= emf->gety_vec()
fu= unwrap_phase(f)
mywindow,2,2,cols=cols,rows=rows
mycontour,fu,z,y
mywindow,2,3,cols=cols,rows=rows
emf->plotphase

;; propagate
emf->check_sampling, drift=drift2
;emf->propfresnel,drift=drift2
emf->propfourier,drift=drift2
mywindow,3,1,cols=cols,rows=rows 
emf->plotintensity
f= emf->getphase(/raw)
z= emf->getz_vec()
y= emf->gety_vec()
fu= unwrap_phase(f)
mywindow,3,2,cols=cols,rows=rows
mycontour,fu,z,y
mywindow,3,3,cols=cols,rows=rows
emf->plotphase
emf->statistics
print, 'check: the fwhm width should be about: 5.5e-5' 

;; end
